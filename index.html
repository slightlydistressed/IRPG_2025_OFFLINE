<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IRPG Offline Reference</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2f6b3f">

<style>
:root { --green:#2f6b3f; --gray:#6b6b6b; --bg:#f4f4f4; --text:#222; }

body { margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:var(--bg); color:var(--text); display:flex; height:100vh; }
aside { width:300px; background:#fff; border-right:1px solid #ccc; overflow-y:auto; }
aside h2, aside h3 { margin:0; padding:0.75rem 1rem; border-bottom:1px solid #ddd; }
nav button { width:100%; border:none; background:none; padding:0.6rem 1rem; text-align:left; cursor:pointer; border-bottom:1px solid #eee; }
nav button:hover { background:#f0f0f0; }
nav .nested { padding-left:1.5rem; }
main { flex:1; overflow-y:auto; padding:1.5rem; }
.pdf-pages canvas { display:block; margin:1rem auto; max-width:100%; box-shadow:0 0 4px rgba(0,0,0,.2); }
.bookmark { float:right; cursor:pointer; font-size:1.2rem; }
textarea { width:100%; min-height:80px; margin-top:1rem; padding:0.5rem; }
</style>
</head>

<body>

<aside>
<h2>IRPG</h2>

<h3>Recent</h3>
<nav id="recentNav"></nav>

<h3>Bookmarks</h3>
<nav id="bookmarkNav"></nav>

<h3>Table of Contents</h3>
<nav id="tocNav"></nav>
</aside>

<main>
<div class="pdf-pages"></div>
<textarea placeholder="Notes..."></textarea>
</main>

<script type="module">
import * as pdfjsLib from './pdf.mjs';

pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.mjs';
const pdfUrl = 'irpg.pdf';
let pdfDoc = null;

const tocNav = document.getElementById('tocNav');
const recentNav = document.getElementById('recentNav');
const bookmarkNav = document.getElementById('bookmarkNav');
const pdfContainer = document.querySelector('.pdf-pages');

// ------------------- PDF Load -------------------
async function loadPDF() {
  pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
  const outline = await pdfDoc.getOutline();
  buildTOC(outline, tocNav);
}
loadPDF();

// ------------------- Render Pages -------------------
async function renderPages(pageNumbers) {
  pdfContainer.innerHTML = '';
  for (const p of pageNumbers) {
    const page = await pdfDoc.getPage(p);
    const viewport = page.getViewport({ scale: 1.5 });
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    pdfContainer.appendChild(canvas);
    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
  }
}

// ------------------- Build TOC -------------------
function buildTOC(items, container, level=0) {
  if (!items) return;
  items.forEach(item => {
    const btn = document.createElement('button');
    btn.textContent = item.title;
    btn.classList.add(level>0?'nested':'');
    btn.onclick = async () => {
      const dest = await pdfDoc.getDestination(item.dest);
      let pageNumbers = [];
      if(dest && dest[0] instanceof Object && 'num' in dest[0]) {
        pageNumbers = [dest[0].num]; // single page
      } else if(typeof dest[0] === 'number') {
        pageNumbers = [dest[0]+1]; // PDF.js pages start at 1
      }
      renderPages(pageNumbers);
      addRecent(item.title);
    };
    container.appendChild(btn);
    if(item.items && item.items.length) {
      buildTOC(item.items, container, level+1);
    }
  });
}

// ------------------- Recent Sections -------------------
function addRecent(title) {
  let r = JSON.parse(localStorage.getItem('recent')||'[]');
  r = r.filter(x=>x!==title);
  r.unshift(title);
  r = r.slice(0,5);
  localStorage.setItem('recent',JSON.stringify(r));
  renderRecent();
}

function renderRecent() {
  recentNav.innerHTML = '';
  (JSON.parse(localStorage.getItem('recent')||'[]')).forEach(title => {
    const btn = document.createElement('button');
    btn.textContent = title;
    btn.onclick = () => {
      const tocBtn = Array.from(tocNav.querySelectorAll('button')).find(b=>b.textContent===title);
      if(tocBtn) tocBtn.click();
    };
    recentNav.appendChild(btn);
  });
}

// ------------------- Bookmarks -------------------
function toggleBookmark(title) {
  let b = JSON.parse(localStorage.getItem('bookmarks')||'[]');
  b.includes(title)? b=b.filter(x=>x!==title) : b.push(title);
  localStorage.setItem('bookmarks',JSON.stringify(b));
  renderBookmarks();
}

function renderBookmarks() {
  bookmarkNav.innerHTML = '';
  (JSON.parse(localStorage.getItem('bookmarks')||'[]')).forEach(title => {
    const btn = document.createElement('button');
    btn.textContent = title;
    btn.onclick = () => {
      const tocBtn = Array.from(tocNav.querySelectorAll('button')).find(b=>b.textContent===title);
      if(tocBtn) tocBtn.click();
    };
    bookmarkNav.appendChild(btn);
  });
}

// ------------------- Notes persistence -------------------
const textarea = document.querySelector('textarea');
textarea.value = localStorage.getItem('notes')||'';
textarea.addEventListener('input',()=>localStorage.setItem('notes',textarea.value));

renderRecent();
renderBookmarks();

// ------------------- Service Worker -------------------
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>
